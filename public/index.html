<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anonymous Liberty - Digital Rights & Privacy</title>
<meta name="description" content="Defending Digital Rights in the Information Age">
<meta name="robots" content="noindex, nofollow">
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}
body {
font-family: 'Courier New', monospace;
background: #0a0a0a;
color: #00ff41;
line-height: 1.4;
overflow-x: hidden;
}
/* Matrix background animation */
.matrix-bg {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
pointer-events: none;
z-index: -1;
background: radial-gradient(ellipse at center, #001100 0%, #000000 70%);
}
/* Notification system */
.notification-panel {
position: fixed;
top: 20px;
right: 20px;
z-index: 1000;
}
.notification {
background: #1a1a1a;
border: 1px solid #00ff41;
padding: 15px;
margin-bottom: 10px;
border-radius: 5px;
color: #00ff41;
cursor: pointer;
max-width: 300px;
animation: slideIn 0.3s ease;
}
.notification.error {
border-color: #ff4444;
color: #ff4444;
}
.notification.success {
border-color: #44ff44;
color: #44ff44;
}
@keyframes slideIn {
from { transform: translateX(100%); opacity: 0; }
to { transform: translateX(0); opacity: 1; }
}
/* Decoy site styles */
.decoy-header {
background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
padding: 20px;
border-bottom: 2px solid #00ff41;
text-align: center;
}
.decoy-logo {
font-size: 2.5em;
font-weight: bold;
margin-bottom: 10px;
text-shadow: 0 0 10px #00ff41;
}
.decoy-tagline {
color: #888;
font-size: 1.1em;
}
.decoy-nav {
background: #1a1a1a;
padding: 15px;
text-align: center;
border-bottom: 1px solid #333;
}
.nav-links {
display: inline-flex;
gap: 30px;
flex-wrap: wrap;
justify-content: center;
}
.nav-links a {
color: #00ff41;
text-decoration: none;
padding: 8px 15px;
border: 1px solid transparent;
transition: all 0.3s;
cursor: pointer;
}
.nav-links a:hover, .nav-links a.active {
border-color: #00ff41;
box-shadow: 0 0 5px #00ff41;
}
.container {
max-width: 1200px;
margin: 0 auto;
padding: 20px;
}
.decoy-content {
display: grid;
grid-template-columns: 2fr 1fr;
gap: 30px;
margin-top: 30px;
}
.article {
background: #1a1a1a;
padding: 25px;
border-radius: 5px;
border: 1px solid #333;
margin-bottom: 20px;
}
.sidebar {
background: #1a1a1a;
padding: 25px;
border-radius: 5px;
border: 1px solid #333;
height: fit-content;
}
.form-group {
margin-bottom: 15px;
}
.form-group label {
display: block;
margin-bottom: 5px;
color: #00ff41;
}
.form-group input, .form-group select, .form-group textarea {
width: 100%;
padding: 8px;
background: #0a0a0a;
border: 1px solid #333;
color: #00ff41;
border-radius: 3px;
font-family: 'Courier New', monospace;
}
.btn {
background: #003300;
color: #00ff41;
border: 1px solid #00ff41;
padding: 10px 20px;
cursor: pointer;
border-radius: 3px;
transition: all 0.3s;
text-decoration: none;
display: inline-block;
font-family: 'Courier New', monospace;
margin-right: 10px;
}
.btn:hover {
background: #00ff41;
color: #000;
box-shadow: 0 0 10px #00ff41;
}
.btn-danger {
background: #660000;
border-color: #ff0000;
color: #ff0000;
}
.btn-danger:hover {
background: #ff0000;
color: #fff;
}
.btn-secondary {
background: #333;
border-color: #666;
color: #ccc;
}
.btn-secondary:hover {
background: #666;
color: #fff;
}
.btn-small {
padding: 5px 10px;
font-size: 0.8em;
}
/* Tab system for login/register */
.auth-tabs {
display: flex;
margin-bottom: 20px;
border-bottom: 1px solid #333;
}
.auth-tab {
background: none;
border: none;
color: #666;
padding: 10px 20px;
cursor: pointer;
font-family: 'Courier New', monospace;
border-bottom: 2px solid transparent;
transition: all 0.3s;
}
.auth-tab.active {
color: #00ff41;
border-bottom-color: #00ff41;
}
.auth-tab:hover {
color: #00ff41;
}
.auth-form {
display: none;
}
.auth-form.active {
display: block;
}
/* Hunter-Net Forum Styles */
.hunter-app {
display: none;
min-height: 100vh;
background: #0a0a0a;
}

.hunter-header {
background: linear-gradient(135deg, #1a0000, #330000);
border-bottom: 2px solid #ff4444;
padding: 15px 0;
}
.hunter-header-content {
max-width: 1200px;
margin: 0 auto;
padding: 0 20px;
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
}
.hunter-logo {
display: flex;
align-items: center;
gap: 15px;
}
.hunter-glyphs {
font-size: 1.5em;
color: #ff4444;
}
.hunter-title {
color: #ff4444;
font-size: 1.8em;
font-weight: bold;
}
.user-info {
display: flex;
align-items: center;
gap: 15px;
color: #ff4444;
flex-wrap: wrap;
font-size: 0.9em;
}
.user-stats {
background: #330000;
padding: 5px 10px;
border-radius: 3px;
border: 1px solid #ff4444;
}
.admin-badge {
background: #ffaa00;
color: #000;
padding: 3px 8px;
border-radius: 3px;
font-size: 0.8em;
font-weight: bold;
}
.moderator-badge {
background: #4444ff;
color: #fff;
padding: 3px 8px;
border-radius: 3px;
font-size: 0.8em;
font-weight: bold;
}
/* Hunter-Net Interface Styles */
.hunter-nav {
background: #1a0000;
padding: 15px;
border-bottom: 1px solid #330000;
}
.hunter-nav-links {
max-width: 1200px;
margin: 0 auto;
display: flex;
gap: 30px;
flex-wrap: wrap;
}
.hunter-nav-links a {
color: #ff4444;
text-decoration: none;
padding: 8px 15px;
border: 1px solid transparent;
transition: all 0.3s;
cursor: pointer;
}
.hunter-nav-links a:hover, .hunter-nav-links a.active {
border-color: #ff4444;
box-shadow: 0 0 5px #ff4444;
}
.hunter-content {
max-width: 1200px;
margin: 0 auto;
padding: 20px;
}

.board-list {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 20px;
margin: 20px 0;
}
.board-card {
background: #1a0000;
border: 1px solid #330000;
border-radius: 5px;
padding: 20px;
cursor: pointer;
transition: all 0.3s;
}
.board-card:hover {
border-color: #ff4444;
box-shadow: 0 0 10px rgba(255, 68, 68, 0.3);
}
.board-title {
color: #ff4444;
font-size: 1.2em;
font-weight: bold;
margin-bottom: 10px;
}
.board-description {
color: #ccc;
font-size: 0.9em;
}
.thread-list {
margin: 20px 0;
}
.thread-item {
background: #1a0000;
border: 1px solid #330000;
border-radius: 5px;
padding: 15px;
margin-bottom: 10px;
cursor: pointer;
transition: all 0.3s;
position: relative;
}
.thread-item:hover {
border-color: #ff4444;
}
.thread-item.sticky {
border-color: #ffaa00;
background: #2a1a00;
}
.thread-item.locked {
opacity: 0.7;
}
.thread-item.pinned {
border-color: #44ff44;
background: #001a00;
}
.thread-title {
color: #ff4444;
font-weight: bold;
margin-bottom: 5px;
}
.thread-meta {
color: #888;
font-size: 0.8em;
display: flex;
gap: 15px;
flex-wrap: wrap;
align-items: center;
}
.signal-badge {
background: #330000;
color: #ff4444;
padding: 2px 6px;
border-radius: 3px;
font-size: 0.7em;
border: 1px solid #ff4444;
}
.vote-controls {
display: flex;
align-items: center;
gap: 10px;
margin-top: 10px;
}
.vote-btn {
background: none;
border: 1px solid #666;
color: #666;
padding: 5px 8px;
cursor: pointer;
border-radius: 3px;
font-family: 'Courier New', monospace;
transition: all 0.3s;
}
.vote-btn:hover {
border-color: #ff4444;
color: #ff4444;
}
.vote-btn.active-up {
border-color: #44ff44;
color: #44ff44;
background: #001100;
}
.vote-btn.active-down {
border-color: #ff4444;
color: #ff4444;
background: #110000;
}
.vote-count {
color: #888;
font-size: 0.9em;
}
.delete-btn {
position: absolute;
top: 10px;
right: 10px;
background: #660000;
color: #ff4444;
border: 1px solid #ff4444;
padding: 2px 6px;
border-radius: 3px;
font-size: 0.7em;
cursor: pointer;
}
.delete-btn:hover {
background: #ff4444;
color: #fff;
}
.chat-interface {
display: grid;
grid-template-columns: 200px 1fr 200px;
gap: 20px;
height: calc(100vh - 200px);
}

.chat-rooms {
background: #1a0000;
border: 1px solid #330000;
border-radius: 5px;
padding: 15px;
overflow-y: auto;
}
.chat-room {
color: #ff4444;
padding: 8px;
cursor: pointer;
border-radius: 3px;
margin-bottom: 5px;
transition: all 0.3s;
}
.chat-room:hover, .chat-room.active {
background: #330000;
}
.chat-main {
display: flex;
flex-direction: column;
background: #1a0000;
border: 1px solid #330000;
border-radius: 5px;
}
.chat-messages {
flex: 1;
padding: 15px;
overflow-y: auto;
max-height: calc(100vh - 350px);
}
.chat-message {
margin-bottom: 10px;
padding: 8px;
background: #0a0000;
border-radius: 3px;
position: relative;
}
.chat-message.mention {
border-left: 3px solid #ffaa00;
background: #1a1100;
}
.chat-author {
color: #ff4444;
font-weight: bold;
margin-right: 10px;
cursor: pointer;
}
.chat-author:hover {
text-decoration: underline;
}
.chat-time {
color: #666;
font-size: 0.7em;
margin-left: 10px;
}
.chat-delete-btn {
position: absolute;
top: 5px;
right: 5px;
background: #660000;
color: #ff4444;
border: none;
padding: 2px 6px;
border-radius: 3px;
font-size: 0.6em;
cursor: pointer;
}
.chat-delete-btn:hover {
background: #ff4444;
color: #fff;
}
.chat-input-area {
border-top: 1px solid #330000;
padding: 15px;
}
.chat-input-main {
display: flex;
gap: 10px;
margin-bottom: 10px;
}
.chat-input-main input {
flex: 1;
background: #0a0000;
border: 1px solid #330000;
color: #ff4444;
padding: 8px;
border-radius: 3px;
font-family: 'Courier New', monospace;
}
.chat-input-tools {
display: flex;
gap: 10px;
align-items: center;
}
.image-upload-area {
position: relative;
}
.image-upload-btn {
background: #330000;
border: 1px solid #ff4444;
color: #ff4444;
padding: 5px 10px;
cursor: pointer;
border-radius: 3px;
font-size: 0.8em;
}
.image-upload-btn:hover {
background: #ff4444;
color: #000;
}
.image-upload-input {
position: absolute;
opacity: 0;
width: 100%;
height: 100%;
cursor: pointer;
}
.chat-image-preview {
max-width: 200px;
max-height: 100px;
margin-top: 10px;
border: 1px solid #333;
border-radius: 3px;
cursor: pointer;
}
.chat-image-preview:hover {
opacity: 0.8;
}
.members-sidebar {
background: #1a0000;
border: 1px solid #330000;
border-radius: 5px;
padding: 15px;
overflow-y: auto;
}

.members-list {
list-style: none;
}
.member-item {
display: flex;
align-items: center;
gap: 10px;
padding: 8px;
border-radius: 3px;
margin-bottom: 5px;
cursor: pointer;
transition: all 0.3s;
}
.member-item:hover {
background: #330000;
}
.online-status {
width: 8px;
height: 8px;
border-radius: 50%;
background: #666;
}
.online-status.online {
background: #44ff44;
}
.member-name {
color: #ff4444;
font-size: 0.9em;
}
.form-container {
max-width: 600px;
margin: 20px auto;
background: #1a0000;
border: 1px solid #330000;
border-radius: 5px;
padding: 25px;
}
.form-container textarea {
min-height: 100px;
resize: vertical;
}
.thread-content {
background: #1a0000;
border: 1px solid #330000;
border-radius: 5px;
padding: 20px;
margin-bottom: 20px;
}
.post-item {
background: #0a0000;
border: 1px solid #330000;
border-radius: 5px;
padding: 15px;
margin-bottom: 15px;
position: relative;
}
.post-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 10px;
padding-bottom: 10px;
border-bottom: 1px solid #330000;
}
.post-author {
color: #ff4444;
font-weight: bold;
cursor: pointer;
}
.post-author:hover {
text-decoration: underline;
}
.post-time {
color: #666;
font-size: 0.8em;
}
.post-body {
color: #ccc;
white-space: pre-wrap;
margin-bottom: 10px;
}
.admin-panel {
background: #2a1a00;
border: 2px solid #ffaa00;
border-radius: 5px;
padding: 20px;
margin-bottom: 20px;
}
.admin-panel h3 {
color: #ffaa00;
margin-bottom: 15px;
}
.user-list {
max-height: 400px;
overflow-y: auto;
border: 1px solid #333;
border-radius: 3px;
}
.user-item {
background: #1a0000;
border-bottom: 1px solid #333;
padding: 15px;
display: grid;
grid-template-columns: 1fr auto;
gap: 15px;
align-items: center;
}
.user-info-admin {
display: grid;
grid-template-columns: 1fr 1fr 1fr;
gap: 10px;
}
.user-actions {
display: flex;
gap: 10px;
flex-wrap: wrap;
}
.account-section {
background: #1a0000;
border: 1px solid #330000;
border-radius: 5px;
padding: 25px;
max-width: 600px;
margin: 20px auto;
}
.account-info {
background: #0a0000;
border: 1px solid #333;
border-radius: 3px;
padding: 15px;
margin-bottom: 20px;
}
.account-info h4 {
color: #ff4444;
margin-bottom: 10px;
}
.account-info p {
color: #ccc;
margin-bottom: 5px;
}
.progress-bar {
width: 100%;
height: 20px;
background: #333;
border-radius: 10px;
margin: 10px 0;
overflow: hidden;
}
.progress-fill {
height: 100%;
background: linear-gradient(90deg, #ff4444, #ffaa00);
transition: width 0.3s ease;
}
.danger-zone {
background: #330000;
border: 1px solid #ff4444;
border-radius: 5px;
padding: 20px;
margin-top: 30px;
}
.danger-zone h3 {
color: #ff4444;
margin-bottom: 15px;
}
.private-message-container {
max-width: 800px;
margin: 20px auto;
background: #1a0000;
border: 1px solid #330000;
border-radius: 5px;
padding: 20px;
}
.pm-list {
max-height: 200px;
overflow-y: auto;
border: 1px solid #333;
border-radius: 3px;
margin-bottom: 20px;
}
.pm-item {
padding: 15px;
border-bottom: 1px solid #333;
cursor: pointer;
transition: all 0.3s;
}
.pm-item:hover {
background: #330000;
}
.pm-item.unread {
background: #1a1100;
border-left: 3px solid #ffaa00;
}
.pm-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 5px;
}
.pm-participants {
color: #ff4444;
font-weight: bold;
}
.pm-timestamp {
color: #666;
font-size: 0.8em;
}
.pm-preview {
color: #ccc;
font-size: 0.9em;
}
.profile-modal {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.8);
z-index: 1000;
display: none;
justify-content: center;
align-items: center;
}
.profile-content {
background: #1a0000;
border: 2px solid #ff4444;
border-radius: 10px;
padding: 30px;
max-width: 600px;
width: 90%;
max-height: 80%;
overflow-y: auto;
}
.profile-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}
.profile-close {
background: #660000;
color: #ff4444;
border: 1px solid #ff4444;
padding: 5px 10px;
border-radius: 3px;
cursor: pointer;
}
.profile-close:hover {
background: #ff4444;
color: #fff;
}
.server-message-banner {
background: #ffaa00;
color: #000;
text-align: center;
padding: 10px;
font-weight: bold;
}
.hidden {
display: none !important;
}
.loading {
text-align: center;
padding: 20px;
color: #666;
}
.error {
background: #330000;
color: #ff4444;
border: 1px solid #ff4444;
padding: 15px;
border-radius: 5px;
margin: 10px 0;
}
.breadcrumb {
color: #666;
margin-bottom: 20px;
}
.breadcrumb a {
color: #ff4444;
text-decoration: none;
}
.breadcrumb a:hover {
text-decoration: underline;
}
.image-preview {
max-width: 300px;
max-height: 200px;
margin: 10px 0;
border: 1px solid #333;
border-radius: 3px;
cursor: pointer;
}
.image-preview:hover {
opacity: 0.8;
}
.image-modal {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.9);
z-index: 2000;
display: none;
justify-content: center;
align-items: center;
}
.image-modal img {
max-width: 90%;
max-height: 90%;
object-fit: contain;
}
.image-modal-close {
position: absolute;
top: 20px;
right: 20px;
background: #660000;
color: #ff4444;
border: 1px solid #ff4444;
padding: 10px 15px;
border-radius: 3px;
cursor: pointer;
font-size: 1.2em;
}
.image-modal-close:hover {
background: #ff4444;
color: #fff;
}
/* Responsive */
@media (max-width: 768px) {
.decoy-content {
grid-template-columns: 1fr;
}
.chat-interface {
grid-template-columns: 1fr;
height: auto;
}
.chat-rooms, .members-sidebar {
max-height: 200px;
}
.user-info-admin {
grid-template-columns: 1fr;
}
}
</style>
</head>
<body>
<div class="matrix-bg"></div>
<div class="notification-panel"></div>
<div id="server-message-banner" class="server-message-banner hidden"></div>

<!-- Image Modal -->
<div id="image-modal" class="image-modal">
<button class="image-modal-close" onclick="closeImageModal()">×</button>
<img id="modal-image" src="" alt="Full size image">
</div>

<!-- Decoy Site -->
<div id="decoy-site" class="decoy-site">
<div class="decoy-header">
<div class="decoy-logo">ANONYMOUS LIBERTY</div>
<div class="decoy-tagline">Defending Digital Rights in the Information Age</div>
</div>
<div class="decoy-nav">
<div class="nav-links">
<a href="#" onclick="showTab('home')" class="nav-link active">Home</a>
<a href="#" onclick="showTab('articles')" class="nav-link">Articles</a>
<a href="#" onclick="showTab('resources')" class="nav-link">Resources</a>
<a href="#" onclick="showTab('contact')" class="nav-link">Contact</a>
</div>
</div>
<div class="container">
<div class="decoy-content">
<div id="main-content">
<div id="home-tab" class="content-tab">
<div class="article">
<h2>Welcome to Anonymous Liberty</h2>
<p>In an age where digital privacy is under constant threat, Anonymous Liberty stands as a beacon for those who refuse to surrender their fundamental rights to privacy and freedom.</p>
<p>We believe that anonymity is not about hiding wrongdoing, but about preserving the space for dissent, creativity, and authentic human connection in an increasingly surveilled world.</p>
<h3>Our Mission</h3>
<p>To educate, advocate, and provide tools for individuals seeking to protect their digital privacy and maintain their anonymity online. We work to ensure that the right to privacy remains a cornerstone of free society.</p>
<h3>Recent Updates</h3>
<ul>
<li>New guide on secure communication protocols</li>
<li>Analysis of recent privacy legislation changes</li>
<li>Updated recommendations for anonymous browsing</li>
</ul>
</div>
</div>
<div id="articles-tab" class="content-tab hidden">
<div class="article">
<h2>Latest Articles</h2>
<h3>The Surveillance State: A Digital Panopticon</h3>
<p>Exploring how modern surveillance systems create a society where privacy becomes a luxury only the tech-savvy can afford...</p>
<h3>Cryptography for Activists</h3>
<p>A comprehensive guide to using encryption tools to protect sensitive communications in high-risk environments...</p>
<h3>The Right to be Forgotten</h3>
<p>Examining the legal and technical challenges of maintaining digital anonymity in an era of permanent records...</p>
</div>
</div>
<div id="resources-tab" class="content-tab hidden">
<div class="article">
<h2>Privacy Resources</h2>
<h3>Recommended Tools</h3>
<ul>
<li>Secure messaging applications</li>
<li>Anonymous browsing solutions</li>
<li>Privacy-focused operating systems</li>
<li>Encryption software reviews</li>
</ul>
<h3>Educational Materials</h3>
<ul>
<li>Digital security best practices</li>
<li>Understanding metadata</li>
<li>Legal rights and privacy laws</li>
<li>Threat modeling for individuals</li>
</ul>
</div>
</div>
<div id="contact-tab" class="content-tab hidden">
<div class="article">
<h2>Secure Contact</h2>
<p>We understand the importance of secure communications. Use these methods to contact us anonymously:</p>
<h3>Anonymous Channels</h3>
<p>For sensitive communications, please use our secure channels. All communications are encrypted and we do not log IP addresses or other identifying information.</p>
<p>Remember: Never use your real name or identifying information when contacting us about sensitive matters.</p>
</div>
</div>
</div>
<div class="sidebar">
<h3>Access Portal</h3>
<p style="color: #888; margin-bottom: 20px;">Authorized personnel only. Multiple security layers active.</p>
<div class="auth-tabs">
<button class="auth-tab active" onclick="showAuth('login')">Access</button>
<button class="auth-tab" onclick="showAuth('register')">Register</button>
</div>
<div id="login-form" class="auth-form active">
<form onsubmit="handleLogin(event)">
<div class="form-group">
<label for="handle_number">Handle:</label>
<input type="text" id="handle_number" name="handle_number" required>
</div>
<div class="form-group">
<label for="login_password">Passphrase:</label>
<input type="password" id="login_password" name="password" required>
</div>
<button type="submit" class="btn">AUTHENTICATE</button>
</form>
</div>
<div id="register-form" class="auth-form">
<form onsubmit="handleRegister(event)">
<div class="form-group">
<label for="handle">Handle:</label>
<input type="text" id="handle" name="handle" required maxlength="20">
<small style="color: #888;">Numbers will be auto-assigned</small>
</div>
<div class="form-group">
<label for="email">Contact (optional):</label>
<input type="email" id="email" name="email">
</div>
<div class="form-group">
<label for="creed">Affiliation:</label>
<select id="creed" name="creed">
<option value="">Select...</option>
<option value="firelight">Firelight</option>
<option value="judgment-day">Judgment Day</option>
<option value="triage">Triage</option>
<option value="unity">Unity</option>
<option value="vigil">Vigil</option>
<option value="vitalis">Vitalis</option>
</select>
</div>
<div class="form-group">
<label for="register_password">Passphrase:</label>
<input type="password" id="register_password" name="password" required minlength="8">
</div>
<button type="submit" class="btn">CREATE ACCOUNT</button>
</form>
</div>
</div>
</div>
</div>
</div>

<!-- Profile Modal -->
<div id="profile-modal" class="profile-modal">
<div class="profile-content">
<div class="profile-header">
<h2 id="profile-title">Member Profile</h2>
<button class="profile-close" onclick="closeProfileModal()">×</button>
</div>
<div id="profile-body">Loading...</div>
</div>
</div>

<!-- Hunter-Net Application -->
<div id="hunter-app" class="hunter-app">
<div class="hunter-header">
<div class="hunter-header-content">
<div class="hunter-logo">
<div class="hunter-glyphs">✟ ☩ ⚔</div>
<div class="hunter-title">HUNTER-NET</div>
</div>
<div class="user-info">
<span id="user-display">Connected</span>
<div class="user-stats">
<span>Field Cred: </span><span id="field-cred">0</span>
</div>
<div id="admin-badge" class="admin-badge hidden">WITNESS</div>
<div id="moderator-badge" class="moderator-badge hidden">MODERATOR</div>
<button class="btn btn-danger" onclick="logout()">Disconnect</button>
</div>
</div>
</div>
<div class="hunter-nav">
<div class="hunter-nav-links">
<a href="#" onclick="showHunterSection('boards')" class="hunter-nav-link active">Boards</a>
<a href="#" onclick="showHunterSection('chat')" class="hunter-nav-link">Secure Chat</a>
<a href="#" onclick="showHunterSection('members')" class="hunter-nav-link">Members</a>
<a href="#" onclick="showHunterSection('messages')" class="hunter-nav-link">Private Messages <span id="pm-badge" class="hidden">●</span></a>
<a href="#" onclick="showHunterSection('account')" class="hunter-nav-link">Account</a>
<a href="#" onclick="showHunterSection('admin')" class="hunter-nav-link" id="admin-nav" style="display: none;">Admin</a>
</div>
</div>
<div class="hunter-content">
<!-- Members Section -->
<div id="members-section" class="hunter-section hidden">
<h2>Active Members</h2>
<div id="members-container" class="members-list">
<div class="loading">Loading members...</div>
</div>
</div>

<!-- Private Messages Section -->
<div id="messages-section" class="hunter-section hidden">
<h2>Private Messages</h2>
<div class="private-message-container">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3>Conversations</h3>
<button class="btn" onclick="showNewMessageForm()">New Message</button>
</div>
<div id="pm-list" class="pm-list">
<div class="loading">Loading conversations...</div>
</div>
<div id="pm-conversation" class="hidden">
<div class="breadcrumb">
<a href="#" onclick="showMessagesList()">Messages</a> > <span id="pm-conversation-title">Conversation</span>
</div>
<div id="pm-messages" class="chat-messages" style="max-height: 400px; border: 1px solid #333; margin-bottom: 20px;"></div>
<div class="form-group">
<textarea id="pm-reply" placeholder="Type your message..."></textarea>
</div>
<div style="display: flex; gap: 10px; margin-top: 10px;">
<button class="btn" onclick="sendPrivateMessage()">Send</button>
<button class="btn btn-secondary" onclick="showMessagesList()">Back</button>
</div>
</div>
<div id="new-message-form" class="hidden">
<div class="breadcrumb">
<a href="#" onclick="showMessagesList()">Messages</a> > New Message
</div>
<form onsubmit="handleNewPrivateMessage(event)">
<div class="form-group">
<label for="pm-recipient">To:</label>
<select id="pm-recipient" required>
<option value="">Select recipient...</option>
</select>
</div>
<div class="form-group">
<label for="pm-subject">Subject:</label>
<input type="text" id="pm-subject" required>
</div>
<div class="form-group">
<label for="pm-content">Message:</label>
<textarea id="pm-content" required></textarea>
</div>
<button type="submit" class="btn">Send Message</button>
<button type="button" class="btn btn-secondary" onclick="showMessagesList()">Cancel</button>
</form>
</div>
</div>
</div>

<!-- Account Section -->
<div id="account-section" class="hunter-section hidden">
<h2>Account Management</h2>
<div class="account-info">
<h4>Account Information</h4>
<p><strong>Handle:</strong> <span id="account-handle">Loading...</span></p>
<p><strong>Field Cred:</strong> <span id="account-field-cred">0</span></p>
<p><strong>Member Status:</strong> <span id="account-status">Active</span></p>
<p><strong>Affiliation:</strong> <span id="account-affiliation">Loading...</span></p>
<div class="progress-bar">
<div id="cred-progress" class="progress-fill" style="width: 0%;"></div>
</div>
<p><strong>Next Level:</strong> <span id="next-level-info">Loading...</span></p>
</div>
<div class="form-container">
<h3>Change Password</h3>
<form onsubmit="handleChangePassword(event)">
<div class="form-group">
<label for="current-password">Current Password:</label>
<input type="password" id="current-password" name="current-password" required>
</div>
<div class="form-group">
<label for="new-password">New Password:</label>
<input type="password" id="new-password" name="new-password" required minlength="8">
</div>
<div class="form-group">
<label for="confirm-password">Confirm New Password:</label>
<input type="password" id="confirm-password" name="confirm-password" required minlength="8">
</div>
<button type="submit" class="btn">Change Password</button>
</form>
</div>
<div class="form-container">
<h3>Change Affiliation</h3>
<form onsubmit="handleChangeAffiliation(event)">
<div class="form-group">
<label for="new-affiliation">New Affiliation:</label>
<select id="new-affiliation" name="new-affiliation">
<option value="">None</option>
<option value="firelight">Firelight</option>
<option value="judgment-day">Judgment Day</option>
<option value="triage">Triage</option>
<option value="unity">Unity</option>
<option value="vigil">Vigil</option>
<option value="vitalis">Vitalis</option>
</select>
</div>
<button type="submit" class="btn">Update Affiliation</button>
</form>
</div>
<div class="danger-zone">
<h3>⚠ Danger Zone</h3>
<p>Permanent account deletion cannot be undone. All posts, threads, and data will be removed.</p>
<form onsubmit="handleDeleteAccount(event)" style="margin-top: 15px;">
<div class="form-group">
<label for="delete-password">Enter password to confirm:</label>
<input type="password" id="delete-password" name="password" required>
</div>
<div class="form-group">
<label for="delete-reason">Reason (optional):</label>
<textarea id="delete-reason" name="reason" placeholder="Why are you deleting your account?"></textarea>
</div>
<button type="submit" class="btn btn-danger">DELETE ACCOUNT PERMANENTLY</button>
</form>
</div>
</div>

<!-- Admin Section -->
<div id="admin-section" class="hunter-section hidden">
<div class="admin-panel">
<h2>WITNESS COMMAND CENTER</h2>
<p style="color: #ffaa00;">Full administrative access to Hunter-Net systems</p>
<div style="margin: 20px 0;">
<button class="btn" onclick="loadAdminUsers()">Refresh User List</button>
<button class="btn btn-secondary" onclick="exportSystemData()">Export Data</button>
<button class="btn" onclick="showServerMessageForm()">Send Server Message</button>
<button class="btn" onclick="showPrivateChatsAdmin()">View Private Chats</button>
</div>
<div id="server-message-form" class="form-container hidden">
<h3>Send Server-Wide Message</h3>
<form onsubmit="handleServerMessage(event)">
<div class="form-group">
<label for="server-msg-content">Message:</label>
<textarea id="server-msg-content" name="server-msg-content" required placeholder="This message will appear to all users..."></textarea>
</div>
<div class="form-group">
<label for="server-msg-type">Type:</label>
<select id="server-msg-type" name="server-msg-type">
<option value="info">Information</option>
<option value="warning">Warning</option>
<option value="event">Event Notice</option>
<option value="maintenance">Maintenance</option>
</select>
</div>
<button type="submit" class="btn">Send Message</button>
<button type="button" class="btn btn-secondary" onclick="hideServerMessageForm()">Cancel</button>
</form>
</div>
<h3>User Management</h3>
<div id="admin-users-container" class="user-list">
<div class="loading">Click Refresh to load users...</div>
</div>
<div id="private-chats-admin" class="hidden">
<h3>Private Conversations Monitor</h3>
<div id="private-chats-list" class="user-list">
<div class="loading">Loading private conversations...</div>
</div>
</div>
</div>
</div>

<!-- Boards Section -->
<div id="boards-section" class="hunter-section">
<div id="board-list-view">
<h2>Hunter-Net Boards</h2>
<div id="boards-container" class="board-list">
<div class="loading">Loading boards...</div>
</div>
</div>
<div id="thread-list-view" class="hidden">
<div class="breadcrumb">
<a href="#" onclick="showBoardList()">Boards</a> > <span id="current-board-name"></span>
</div>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h2 id="board-title"></h2>
<button class="btn" onclick="showNewThreadForm()">New Thread</button>
</div>
<div id="threads-container" class="thread-list">
<div class="loading">Loading threads...</div>
</div>
</div>
<div id="thread-view" class="hidden">
<div class="breadcrumb">
<a href="#" onclick="showBoardList()">Boards</a> >
<a href="#" onclick="showThreadList()" id="breadcrumb-board"></a> >
<span id="current-thread-title"></span>
</div>
<div id="thread-content"></div>
<div id="posts-container"></div>
<div class="form-container" id="reply-form">
<h3>Reply to Thread</h3>
<form onsubmit="handleNewPost(event)">
<div class="form-group">
<label for="post-body">Message:</label>
<textarea id="post-body" name="body_md" required></textarea>
</div>
<div class="form-group">
<label for="post-image">Image (optional):</label>
<input type="file" id="post-image" accept="image/*" onchange="previewImage(event, 'post-preview')">
<img id="post-preview" class="image-preview hidden">
</div>
<button type="submit" class="btn">Post Reply</button>
</form>
</div>
</div>
<div id="new-thread-form" class="hidden">
<div class="breadcrumb">
<a href="#" onclick="showBoardList()">Boards</a> >
<a href="#" onclick="showThreadList()" id="breadcrumb-board-2"></a> >
New Thread
</div>
<div class="form-container">
<h2>Create New Thread</h2>
<form onsubmit="handleNewThread(event)">
<div class="form-group">
<label for="thread-title">Title:</label>
<input type="text" id="thread-title" name="title" required>
</div>
<div class="form-group">
<label for="thread-signal">Signal Type:</label>
<select id="thread-signal" name="signal">
<option value="">Select...</option>
<option value="sighting">Sighting</option>
<option value="intel">Intel</option>
<option value="request-aid">Request Aid</option>
<option value="after-action">After Action</option>
<option value="caution">Caution</option>
</select>
</div>
<div class="form-group">
<label for="thread-tags">Tags:</label>
<input type="text" id="thread-tags" name="tags" placeholder="vampire, chicago, urgent">
</div>
<div class="form-group">
<label for="thread-body">Message:</label>
<textarea id="thread-body" name="body_md" required></textarea>
</div>
<div class="form-group">
<label for="thread-image">Image (optional):</label>
<input type="file" id="thread-image" accept="image/*" onchange="previewImage(event, 'thread-preview')">
<img id="thread-preview" class="image-preview hidden">
</div>
<button type="submit" class="btn">Create Thread</button>
<button type="button" class="btn btn-secondary" onclick="showThreadList()">Cancel</button>
</form>
</div>
</div>
</div>

<!-- Chat Section with Members Sidebar -->
<div id="chat-section" class="hunter-section hidden">
<h2>Secure Communications</h2>
<div class="chat-interface">
<div class="chat-rooms">
<h3>Channels</h3>
<div id="chat-rooms-list"></div>
</div>
<div class="chat-main">
<div class="chat-messages" id="chat-messages"></div>
<div class="chat-input-area">
<div class="chat-input-main">
<input type="text" id="chat-input" placeholder="Enter message... (@username to mention)" onkeypress="handleChatKeypress(event)">
<button class="btn" onclick="sendChatMessage()">Send</button>
</div>
<div class="chat-input-tools">
<div class="image-upload-area">
<label class="image-upload-btn">
📷 Image
<input type="file" class="image-upload-input" id="chat-image-input" accept="image/*" onchange="previewChatImage(event)">
</label>
</div>
<button class="btn btn-secondary btn-small" onclick="clearChatImage()">Clear</button>
</div>
<img id="chat-image-preview" class="chat-image-preview hidden">
</div>
</div>
<div class="members-sidebar">
<h3>Online Members</h3>
<div id="chat-members-list" class="members-list">
<div class="loading">Loading...</div>
</div>
</div>
</div>
</div>
</div>
</div>

<script>
// Global state
let currentUser = null;
let currentBoard = null;
let currentThread = null;
let currentPrivateConversation = null;
let socket = null;
let currentChatRoom = 'global';
let chatMessages = {};
let chatImageData = null;
let onlineMembers = [];
let fieldCredLevels = [0, 100, 250, 500, 1000, 2000, 3500, 5000, 7500, 10000];

// Persistent chat message storage with full history
const chatHistory = {
    global: [
        {
            id: 1,
            author: 'witness1',
            body: 'All hunters report status.',
            created_at: '2024-01-15T20:00:00Z',
            room_key: 'global',
            image_path: null
        },
        {
            id: 2,
            author: 'hunter001',
            body: 'Chicago sector clear. @witness1 the warehouse sweep was successful.',
            created_at: '2024-01-15T20:05:00Z',
            room_key: 'global',
            image_path: null
        },
        {
            id: 3,
            author: 'tracker007',
            body: 'Multiple vampire contacts confirmed in downtown area. Proceeding with caution.',
            created_at: '2024-01-15T20:10:00Z',
            room_key: 'global',
            image_path: null
        },
        {
            id: 4,
            author: 'witness1',
            body: 'Good work. Maintain surveillance protocols. All units stay vigilant.',
            created_at: '2024-01-15T20:12:00Z',
            room_key: 'global',
            image_path: null
        }
    ],
    firelight: [
        {
            id: 501,
            author: 'tracker007',
            body: 'Firelight cell coordination - new purification protocols have been distributed.',
            created_at: '2024-01-15T19:00:00Z',
            room_key: 'firelight',
            image_path: null
        },
        {
            id: 502,
            author: 'purifier001',
            body: 'Confirmed receipt. Already implementing the new sanctification procedures.',
            created_at: '2024-01-15T19:15:00Z',
            room_key: 'firelight',
            image_path: null
        }
    ],
    'judgment-day': [
        {
            id: 601,
            author: 'witness1',
            body: 'Judgment Day operations are proceeding on schedule. All prophecies align.',
            created_at: '2024-01-15T18:45:00Z',
            room_key: 'judgment-day',
            image_path: null
        },
        {
            id: 602,
            author: 'prophet001',
            body: 'The signs are clear. Prepare for the next phase of revelation.',
            created_at: '2024-01-15T19:30:00Z',
            room_key: 'judgment-day',
            image_path: null
        }
    ],
    triage: [
        {
            id: 701,
            author: 'medic001',
            body: 'Triage unit standing by. Medical supplies restocked and ready for deployment.',
            created_at: '2024-01-15T17:30:00Z',
            room_key: 'triage',
            image_path: null
        },
        {
            id: 702,
            author: 'field_surgeon',
            body: 'Emergency protocols updated. New trauma kit specifications uploaded.',
            created_at: '2024-01-15T18:00:00Z',
            room_key: 'triage',
            image_path: null
        }
    ],
    unity: [
        {
            id: 801,
            author: 'diplomat001',
            body: 'Unity negotiations with local authorities proceeding smoothly.',
            created_at: '2024-01-15T16:45:00Z',
            room_key: 'unity',
            image_path: null
        },
        {
            id: 802,
            author: 'liaison_agent',
            body: 'Public relations campaign showing positive results. Cover stories holding.',
            created_at: '2024-01-15T17:20:00Z',
            room_key: 'unity',
            image_path: null
        }
    ],
    vigil: [
        {
            id: 901,
            author: 'hunter001',
            body: 'Vigil patrol routes optimized. Night watch schedules distributed.',
            created_at: '2024-01-15T19:45:00Z',
            room_key: 'vigil',
            image_path: null
        },
        {
            id: 902,
            author: 'sentinel002',
            body: 'Confirmed. Surveillance equipment checked and operational.',
            created_at: '2024-01-15T20:15:00Z',
            room_key: 'vigil',
            image_path: null
        }
    ],
    vitalis: [
        {
            id: 1001,
            author: 'researcher001',
            body: 'Vitalis research into supernatural physiology yielding promising results.',
            created_at: '2024-01-15T15:30:00Z',
            room_key: 'vitalis',
            image_path: null
        },
        {
            id: 1002,
            author: 'scientist_v',
            body: 'New biological samples secured for analysis. Lab protocols updated.',
            created_at: '2024-01-15T16:10:00Z',
            room_key: 'vitalis',
            image_path: null
        }
    ],
    admin: [
        {
            id: 301,
            author: 'witness1',
            body: 'System maintenance completed. All security protocols are operational.',
            created_at: '2024-01-15T14:00:00Z',
            room_key: 'admin',
            image_path: null
        }
    ]
};

// Client storage utility (using memory instead of localStorage)
const hunterStorage = {
    data: {},
    set(key, value) {
        try {
            this.data[key] = JSON.stringify(value);
            return true;
        } catch (error) {
            console.error('Storage error:', error);
            return false;
        }
    },
    get(key, defaultValue = null) {
        try {
            const item = this.data[key];
            return item ? JSON.parse(item) : defaultValue;
        } catch (error) {
            console.error('Storage error:', error);
            return defaultValue;
        }
    },
    remove(key) {
        try {
            delete this.data[key];
            return true;
        } catch (error) {
            console.error('Storage error:', error);
            return false;
        }
    },
    storeVote(targetType, targetId, voteData) {
        const votes = this.get('votes', {});
        const key = `${targetType}_${targetId}`;
        votes[key] = voteData;
        this.set('votes', votes);
    },
    getVote(targetType, targetId) {
        const votes = this.get('votes', {});
        const key = `${targetType}_${targetId}`;
        return votes[key] || null;
    }
};

// Mock API helpers with proper witness1 admin access
async function apiRequest(url, options = {}) {
    // Simulate network delay
    await new Promise(resolve => setTimeout(resolve, 300));
    
    if (url === '/api/login') {
        const credentials = JSON.parse(options.body);
        // Only witness1 with proper admin privileges
        if (credentials.handle_number === 'witness1' && credentials.password === 'admin123') {
            return {
                user: {
                    id: 1,
                    handle_number: 'witness1',
                    field_cred: 10000,
                    creed: 'judgment-day',
                    is_admin: true,
                    is_moderator: true,
                    created_at: '2023-01-01'
                }
            };
        } else {
            throw new Error('Invalid credentials');
        }
    }
    
    if (url === '/api/register') {
        const data = JSON.parse(options.body);
        const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        return {
            user: {
                id: Math.floor(Math.random() * 1000),
                handle_number: `${data.handle}${randomNum}`,
                field_cred: 0,
                creed: data.creed || null,
                is_admin: false,
                is_moderator: false,
                created_at: new Date().toISOString()
            }
        };
    }
    
    if (url === '/api/boards') {
        return {
            boards: [
                { key: 'general', name: 'General Discussion', description: 'General hunter communications' },
                { key: 'firelight', name: 'Firelight', description: 'Purification and sanctification operations' },
                { key: 'judgment-day', name: 'Judgment Day', description: 'Prophetic visions and revelations' },
                { key: 'triage', name: 'Triage', description: 'Medical support and field treatment' },
                { key: 'unity', name: 'Unity', description: 'Public relations and civilian coordination' },
                { key: 'vigil', name: 'Vigil', description: 'Surveillance and patrol operations' },
                { key: 'vitalis', name: 'Vitalis', description: 'Research and biological studies' },
                { key: 'admin', name: 'Admin Board', description: 'Administrative discussions and system updates' }
            ]
        };
    }
    
    if (url.includes('/api/boards/') && url.includes('/threads')) {
        return {
            threads: [
                {
                    id: 1,
                    title: 'Vampire Activity in Chicago',
                    author: 'hunter001',
                    created_at: '2024-01-15T12:00:00Z',
                    post_count: 5,
                    signal_type: 'sighting',
                    tags: 'vampire, chicago, urgent',
                    upvotes: 8,
                    downvotes: 1,
                    sticky: false,
                    locked: false,
                    pinned: true
                },
                {
                    id: 2,
                    title: 'System Security Update',
                    author: 'witness1',
                    created_at: '2024-01-14T10:30:00Z',
                    post_count: 12,
                    signal_type: null,
                    tags: 'security, admin',
                    upvotes: 15,
                    downvotes: 0,
                    sticky: true,
                    locked: false,
                    pinned: false
                }
            ]
        };
    }
    
    if (url.includes('/api/threads/') && !url.includes('/posts')) {
        return {
            thread: {
                id: 1,
                title: 'Vampire Activity in Chicago',
                author: 'hunter001',
                body_md: 'Witnessed suspicious activity near the old warehouse district. Three individuals with pale skin and red eyes. Avoided direct sunlight. Recommend caution when patrolling this area.',
                created_at: '2024-01-15T12:00:00Z',
                signal_type: 'sighting',
                tags: 'vampire, chicago, urgent',
                upvotes: 8,
                downvotes: 1,
                sticky: false,
                locked: false,
                pinned: true,
                image_path: null
            },
            posts: [
                {
                    id: 1,
                    author: 'witness1',
                    body_md: 'Good intel. I\'ll coordinate with local cells for increased patrols.',
                    created_at: '2024-01-15T14:00:00Z',
                    upvotes: 5,
                    downvotes: 0,
                    image_path: null
                },
                {
                    id: 2,
                    author: 'tracker007',
                    body_md: 'I can confirm this. Saw similar activity last week. We should organize a sweep.',
                    created_at: '2024-01-15T16:30:00Z',
                    upvotes: 3,
                    downvotes: 0,
                    image_path: null
                }
            ]
        };
    }
    
    if (url === '/api/members') {
        return {
            members: [
                {
                    handle_number: 'witness1',
                    field_cred: 10000,
                    creed: 'judgment-day',
                    is_admin: true,
                    is_moderator: true,
                    is_online: true,
                    created_at: '2023-01-01',
                    active_threads: 25,
                    post_count: 150,
                    message_count: 500
                },
                {
                    handle_number: 'hunter001',
                    field_cred: 250,
                    creed: 'vigil',
                    is_admin: false,
                    is_moderator: false,
                    is_online: true,
                    created_at: '2023-06-15',
                    active_threads: 5,
                    post_count: 25,
                    message_count: 100
                },
                {
                    handle_number: 'tracker007',
                    field_cred: 1500,
                    creed: 'firelight',
                    is_admin: false,
                    is_moderator: true,
                    is_online: false,
                    created_at: '2023-03-20',
                    active_threads: 15,
                    post_count: 75,
                    message_count: 200
                }
            ]
        };
    }
    
    if (url === '/api/private-messages') {
        return {
            conversations: [
                {
                    id: 1,
                    subject: 'Re: Chicago Operations',
                    other_participant: 'hunter001',
                    last_message_at: '2024-01-15T18:00:00Z',
                    unread_count: 2
                },
                {
                    id: 2,
                    subject: 'Equipment Request',
                    other_participant: 'tracker007',
                    last_message_at: '2024-01-14T15:30:00Z',
                    unread_count: 0
                }
            ]
        };
    }
    
    if (url.includes('/api/private-messages/') && !url.includes('/reply') && !url.includes('/read')) {
        return {
            messages: [
                {
                    id: 1,
                    sender: 'hunter001',
                    content: 'Good work on the Chicago report. Keep me updated on any developments.',
                    created_at: '2024-01-15T17:00:00Z'
                },
                {
                    id: 2,
                    sender: currentUser?.handle_number || 'witness1',
                    content: 'Will do. Planning another sweep tomorrow night.',
                    created_at: '2024-01-15T17:30:00Z'
                }
            ]
        };
    }
    
    if (url === '/api/chat/rooms') {
        return {
            rooms: [
                { key: 'global', title: 'Global Chat' },
                { key: 'firelight', title: 'Firelight' },
                { key: 'judgment-day', title: 'Judgment Day' },
                { key: 'triage', title: 'Triage' },
                { key: 'unity', title: 'Unity' },
                { key: 'vigil', title: 'Vigil' },
                { key: 'vitalis', title: 'Vitalis' },
                { key: 'admin', title: 'Admin Only' }
            ]
        };
    }
    
    if (url.includes('/api/chat/rooms/') && url.includes('/messages')) {
        const roomKey = url.split('/')[4];
        return {
            messages: chatHistory[roomKey] || []
        };
    }
    
    if (url === '/api/admin/users') {
        if (!currentUser?.is_admin) {
            throw new Error('Access denied');
        }
        return {
            users: [
                {
                    id: 1,
                    handle_number: 'witness1',
                    creed: 'judgment-day',
                    field_cred: 10000,
                    thread_count: 25,
                    post_count: 150,
                    email: 'admin@hunternet.secure',
                    created_at: '2023-01-01',
                    active: 'active',
                    is_moderator: true
                },
                {
                    id: 2,
                    handle_number: 'hunter001',
                    creed: 'vigil',
                    field_cred: 250,
                    thread_count: 5,
                    post_count: 25,
                    email: null,
                    created_at: '2023-06-15',
                    active: 'active',
                    is_moderator: false
                },
                {
                    id: 3,
                    handle_number: 'tracker007',
                    creed: 'firelight',
                    field_cred: 1500,
                    thread_count: 15,
                    post_count: 75,
                    email: null,
                    created_at: '2023-03-20',
                    active: 'active',
                    is_moderator: true
                }
            ]
        };
    }
    
    // Mock successful responses for other endpoints
    if (options.method === 'POST' || options.method === 'PATCH' || options.method === 'DELETE') {
        return { success: true };
    }
    return { success: true };
}

// Image modal functionality
function openImageModal(src) {
    const modal = document.getElementById('image-modal');
    const modalImage = document.getElementById('modal-image');
    modalImage.src = src;
    modal.style.display = 'flex';
}

function closeImageModal() {
    document.getElementById('image-modal').style.display = 'none';
}

// Field Cred calculation
function calculateFieldCredProgress(currentCred) {
    let currentLevel = 0;
    let nextLevel = 1;
    let nextLevelCred = fieldCredLevels[1];
    
    for (let i = 0; i < fieldCredLevels.length - 1; i++) {
        if (currentCred >= fieldCredLevels[i] && currentCred < fieldCredLevels[i + 1]) {
            currentLevel = i;
            nextLevel = i + 1;
            nextLevelCred = fieldCredLevels[i + 1];
            break;
        }
    }
    
    if (currentCred >= fieldCredLevels[fieldCredLevels.length - 1]) {
        currentLevel = fieldCredLevels.length - 1;
        nextLevel = currentLevel;
        nextLevelCred = fieldCredLevels[currentLevel];
    }
    
    const levelStart = fieldCredLevels[currentLevel];
    const levelEnd = nextLevelCred;
    const progress = ((currentCred - levelStart) / (levelEnd - levelStart)) * 100;
    
    return {
        currentLevel,
        nextLevel,
        nextLevelCred,
        progress: Math.min(progress, 100),
        credNeeded: Math.max(0, nextLevelCred - currentCred)
    };
}

// Chat image preview and handling
function previewChatImage(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('chat-image-preview');
    
    if (file) {
        if (file.size > 5 * 1024 * 1024) {
            showNotification('Image too large. Maximum 5MB allowed.', 'error');
            event.target.value = '';
            preview.classList.add('hidden');
            chatImageData = null;
            return;
        }
        
        if (!file.type.startsWith('image/')) {
            showNotification('Only image files are allowed.', 'error');
            event.target.value = '';
            preview.classList.add('hidden');
            chatImageData = null;
            return;
        }
        
        chatImageData = file;
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
            preview.onclick = () => openImageModal(e.target.result);
        };
        reader.readAsDataURL(file);
    } else {
        preview.classList.add('hidden');
        chatImageData = null;
    }
}

function clearChatImage() {
    const input = document.getElementById('chat-image-input');
    const preview = document.getElementById('chat-image-preview');
    input.value = '';
    preview.classList.add('hidden');
    chatImageData = null;
}

// Image preview
function previewImage(event, previewId) {
    const file = event.target.files[0];
    const preview = document.getElementById(previewId);
    
    if (file) {
        if (file.size > 5 * 1024 * 1024) {
            showNotification('Image too large. Maximum 5MB allowed.', 'error');
            event.target.value = '';
            preview.classList.add('hidden');
            return;
        }
        
        if (!file.type.startsWith('image/')) {
            showNotification('Only image files are allowed.', 'error');
            event.target.value = '';
            preview.classList.add('hidden');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
            preview.onclick = () => openImageModal(e.target.result);
        };
        reader.readAsDataURL(file);
    } else {
        preview.classList.add('hidden');
    }
}

// Voting system
async function vote(targetType, targetId, voteType) {
    try {
        const data = await apiRequest('/api/vote', {
            method: 'POST',
            body: JSON.stringify({
                target_type: targetType,
                target_id: targetId,
                vote_type: voteType
            })
        });
        
        hunterStorage.storeVote(targetType, targetId, {
            user_vote: voteType,
            upvotes: (targetType === 'thread' ? 8 : 5) + (voteType === 'up' ? 1 : 0),
            downvotes: (targetType === 'thread' ? 1 : 0) + (voteType === 'down' ? 1 : 0)
        });
        
        updateVoteDisplay(targetType, targetId, {
            user_vote: voteType,
            upvotes: (targetType === 'thread' ? 8 : 5) + (voteType === 'up' ? 1 : 0),
            downvotes: (targetType === 'thread' ? 1 : 0) + (voteType === 'down' ? 1 : 0)
        });
        
        showNotification(`Vote ${voteType === 'up' ? 'up' : 'down'} recorded`, 'success');
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

function updateVoteDisplay(targetType, targetId, voteData) {
    const voteContainer = document.getElementById(`vote-${targetType}-${targetId}`);
    if (voteContainer) {
        const upBtn = voteContainer.querySelector('.vote-up');
        const downBtn = voteContainer.querySelector('.vote-down');
        const upCount = voteContainer.querySelector('.up-count');
        const downCount = voteContainer.querySelector('.down-count');
        
        upBtn.classList.toggle('active-up', voteData.user_vote === 'up');
        downBtn.classList.toggle('active-down', voteData.user_vote === 'down');
        
        upCount.textContent = voteData.upvotes;
        downCount.textContent = voteData.downvotes;
    }
}

function createVoteControls(targetType, targetId, voteData = {}) {
    return `
        <div id="vote-${targetType}-${targetId}" class="vote-controls">
            <button class="vote-btn vote-up ${voteData.user_vote === 'up' ? 'active-up' : ''}"
                    onclick="vote('${targetType}', ${targetId}, 'up')">
                ▲ <span class="up-count">${voteData.upvotes || 0}</span>
            </button>
            <button class="vote-btn vote-down ${voteData.user_vote === 'down' ? 'active-down' : ''}"
                    onclick="vote('${targetType}', ${targetId}, 'down')">
                ▼ <span class="down-count">${voteData.downvotes || 0}</span>
            </button>
        </div>
    `;
}

// Delete functionality
async function deleteContent(type, id, messageId = null) {
    if (!confirm(`Are you sure you want to delete this ${type}? This cannot be undone.`)) {
        return;
    }
    
    try {
        let endpoint = '';
        if (type === 'thread') {
            endpoint = `/api/threads/${id}`;
        } else if (type === 'post') {
            endpoint = `/api/posts/${id}`;
        } else if (type === 'message') {
            endpoint = `/api/chat/messages/${messageId || id}`;
        }
        
        await apiRequest(endpoint, { method: 'DELETE' });
        
        showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully`, 'success');
        
        // Refresh current view
        if (type === 'thread' && currentBoard) {
            loadThreads(currentBoard.key, currentBoard.name);
        } else if (type === 'post' && currentThread) {
            loadThread(currentThread.id, currentThread.title);
        } else if (type === 'message') {
            loadChatMessages(currentChatRoom);
        }
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

// Notification system
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.onclick = () => notification.remove();
    
    document.querySelector('.notification-panel').appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Tab switching for decoy site
function showTab(tabName) {
    document.querySelectorAll('.content-tab').forEach(tab => tab.classList.add('hidden'));
    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
    
    const targetTab = document.getElementById(`${tabName}-tab`);
    if (targetTab) {
        targetTab.classList.remove('hidden');
    }
    event.target.classList.add('active');
}

// Auth tab switching
function showAuth(authType) {
    document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
    document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
    
    const targetForm = document.getElementById(`${authType}-form`);
    if (targetForm) {
        targetForm.classList.add('active');
    }
    event.target.classList.add('active');
}

// Authentication handlers
async function handleLogin(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        showNotification('Authenticating...', 'info');
        const data = await apiRequest('/api/login', {
            method: 'POST',
            body: JSON.stringify({
                handle_number: formData.get('handle_number'),
                password: formData.get('password')
            })
        });
        
        currentUser = data.user;
        initializeHunterNet();
        showNotification('Access granted. Welcome to Hunter-Net.', 'success');
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

async function handleRegister(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        showNotification('Creating account...', 'info');
        const data = await apiRequest('/api/register', {
            method: 'POST',
            body: JSON.stringify({
                handle: formData.get('handle'),
                email: formData.get('email') || undefined,
                password: formData.get('password'),
                creed: formData.get('creed') || undefined
            })
        });
        
        currentUser = data.user;
        initializeHunterNet();
        showNotification(`Account created. Welcome ${data.user.handle_number}`, 'success');
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

// Account management
async function handleChangePassword(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const newPassword = formData.get('new-password');
    const confirmPassword = formData.get('confirm-password');
    
    if (newPassword !== confirmPassword) {
        showNotification('Passwords do not match', 'error');
        return;
    }
    
    try {
        await apiRequest('/api/account/password', {
            method: 'PATCH',
            body: JSON.stringify({
                current_password: formData.get('current-password'),
                new_password: newPassword
            })
        });
        
        showNotification('Password updated successfully', 'success');
        event.target.reset();
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

async function handleChangeAffiliation(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        const data = await apiRequest('/api/account/affiliation', {
            method: 'PATCH',
            body: JSON.stringify({
                affiliation: formData.get('new-affiliation') || null
            })
        });
        
        currentUser.creed = formData.get('new-affiliation') || null;
        document.getElementById('account-affiliation').textContent = currentUser.creed || 'None';
        showNotification('Affiliation updated successfully', 'success');
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

async function handleDeleteAccount(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const password = formData.get('password');
    const reason = formData.get('reason');
    
    if (!confirm('Are you ABSOLUTELY sure you want to delete your account? This cannot be undone!')) {
        return;
    }
    
    try {
        showNotification('Deleting account...', 'info');
        await apiRequest('/api/account', {
            method: 'DELETE',
            body: JSON.stringify({
                password: password,
                reason: reason || 'User requested deletion'
            })
        });
        
        showNotification('Account deleted successfully. You will be disconnected.', 'success');
        setTimeout(() => {
            logout();
        }, 2000);
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

function logout() {
    currentUser = null;
    currentBoard = null;
    currentThread = null;
    currentPrivateConversation = null;
    chatMessages = {};
    chatImageData = null;
    onlineMembers = [];
    
    if (socket) {
        socket.disconnect();
        socket = null;
    }
    
    apiRequest('/api/logout', { method: 'POST' }).catch(() => {});
    
    document.getElementById('decoy-site').style.display = 'block';
    document.getElementById('hunter-app').style.display = 'none';
    
    showNotification('Disconnected from Hunter-Net.', 'info');
}

// Hunter-Net initialization
function initializeHunterNet() {
    document.getElementById('decoy-site').style.display = 'none';
    document.getElementById('hunter-app').style.display = 'block';
    
    document.getElementById('user-display').textContent = currentUser.handle_number;
    document.getElementById('field-cred').textContent = currentUser.field_cred || 0;
    
    // Update account section
    document.getElementById('account-handle').textContent = currentUser.handle_number;
    document.getElementById('account-field-cred').textContent = currentUser.field_cred || 0;
    document.getElementById('account-affiliation').textContent = currentUser.creed || 'None';
    document.getElementById('new-affiliation').value = currentUser.creed || '';
    
    // Calculate field cred progress
    const credProgress = calculateFieldCredProgress(currentUser.field_cred || 0);
    document.getElementById('cred-progress').style.width = `${credProgress.progress}%`;
    document.getElementById('next-level-info').textContent =
        credProgress.credNeeded > 0 ?
        `${credProgress.credNeeded} cred needed for level ${credProgress.nextLevel}` :
        'Maximum level reached!';
    
    // Show admin/moderator features
    if (currentUser.is_admin) {
        document.getElementById('admin-nav').style.display = 'block';
        document.getElementById('admin-badge').classList.remove('hidden');
    }
    if (currentUser.is_moderator) {
        document.getElementById('moderator-badge').classList.remove('hidden');
    }
    
    // Initialize Socket.IO connection (mock)
    initializeSocket();
    
    // Load initial data
    loadBoards();
    loadChatRooms();
    loadMembers();
    loadPrivateMessages();
    checkServerMessages();
}

// Socket connection management (mock)
function initializeSocket() {
    // Mock socket implementation
    socket = {
        connected: true,
        emit: function(event, data) {
            console.log('Socket emit:', event, data);
        },
        on: function(event, callback) {
            console.log('Socket listener:', event);
        },
        disconnect: function() {
            this.connected = false;
        }
    };
    
    showNotification('Chat server connected', 'success');
}

// Server message handling
function showServerMessage(message, type) {
    const banner = document.getElementById('server-message-banner');
    banner.textContent = message;
    banner.className = `server-message-banner ${type}`;
    banner.classList.remove('hidden');
    
    setTimeout(() => {
        banner.classList.add('hidden');
    }, 10000);
}

async function checkServerMessages() {
    try {
        const data = await apiRequest('/api/server-messages');
        if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => {
                showServerMessage(msg.content, msg.type);
            });
        }
    } catch (error) {
        console.error('Failed to check server messages:', error);
    }
}

// Hunter-Net navigation
function showHunterSection(sectionName) {
    document.querySelectorAll('.hunter-section').forEach(section => 
        section.classList.add('hidden'));
    document.querySelectorAll('.hunter-nav-link').forEach(link => 
        link.classList.remove('active'));
    
    const targetSection = document.getElementById(`${sectionName}-section`);
    if (targetSection) {
        targetSection.classList.remove('hidden');
    }
    event.target.classList.add('active');
    
    if (sectionName === 'chat') {
        if (socket && socket.connected) {
            socket.emit('join', currentChatRoom);
        }
        loadChatMessages(currentChatRoom);
        loadChatMembers();
    } else if (sectionName === 'members') {
        loadMembers();
    } else if (sectionName === 'messages') {
        loadPrivateMessages();
    }
}

// Members functionality
async function loadMembers() {
    try {
        const data = await apiRequest('/api/members');
        displayMembers(data.members);
    } catch (error) {
        document.getElementById('members-container').innerHTML = 
            `<div class="error">Failed to load members: ${error.message}</div>`;
    }
}

function displayMembers(members) {
    const container = document.getElementById('members-container');
    
    // Sort members: admins first, then moderators, then regular users by creation date
    members.sort((a, b) => {
        if (a.is_admin && !b.is_admin) return -1;
        if (!a.is_admin && b.is_admin) return 1;
        if (a.is_moderator && !b.is_moderator) return -1;
        if (!a.is_moderator && b.is_moderator) return 1;
        return new Date(a.created_at) - new Date(b.created_at);
    });
    
    container.innerHTML = members.map(member => `
        <div class="member-item" onclick="showMemberProfile('${member.handle_number}')">
            <div class="online-status ${member.is_online ? 'online' : ''}"></div>
            <div class="member-name">
                ${member.handle_number}
                ${member.is_admin ? '<span style="color: #ffaa00;">[WITNESS]</span>' : ''}
                ${member.is_moderator && !member.is_admin ? '<span style="color: #4444ff;">[MOD]</span>' : ''}
            </div>
        </div>
    `).join('');
}

// Member profile functionality
async function showMemberProfile(handleNumber) {
    try {
        const data = await apiRequest(`/api/members/${handleNumber}`);
        displayMemberProfile(data.member || 
            // Mock member data if not found
            {
                handle_number: handleNumber,
                field_cred: Math.floor(Math.random() * 5000),
                creed: ['firelight', 'judgment-day', 'triage', 'unity', 'vigil', 'vitalis'][Math.floor(Math.random() * 6)],
                is_online: Math.random() > 0.5,
                created_at: '2023-06-01',
                is_admin: handleNumber === 'witness1',
                is_moderator: handleNumber === 'witness1' || handleNumber === 'tracker007',
                active_threads: Math.floor(Math.random() * 20),
                post_count: Math.floor(Math.random() * 100),
                message_count: Math.floor(Math.random() * 300)
            }
        );
    } catch (error) {
        showNotification(`Failed to load profile: ${error.message}`, 'error');
    }
}

function displayMemberProfile(member) {
    const modal = document.getElementById('profile-modal');
    const title = document.getElementById('profile-title');
    const body = document.getElementById('profile-body');
    
    title.textContent = `${member.handle_number} Profile`;
    
    const credProgress = calculateFieldCredProgress(member.field_cred || 0);
    
    body.innerHTML = `
        <div class="account-info">
            <p><strong>Handle:</strong> ${member.handle_number}</p>
            <p><strong>Field Cred:</strong> ${member.field_cred || 0} (Level ${credProgress.currentLevel})</p>
            <p><strong>Affiliation:</strong> ${member.creed || 'None'}</p>
            <p><strong>Status:</strong> ${member.is_online ? 'Online' : 'Offline'}</p>
            <p><strong>Member Since:</strong> ${new Date(member.created_at).toLocaleDateString()}</p>
            ${member.is_admin ? '<p><strong>Role:</strong> <span style="color: #ffaa00;">Witness</span></p>' : ''}
            ${member.is_moderator && !member.is_admin ? '<p><strong>Role:</strong> <span style="color: #4444ff;">Moderator</span></p>' : ''}
        </div>
        <div style="margin-top: 20px;">
            <h4>Activity</h4>
            <p>Active Threads: ${member.active_threads || 0}</p>
            <p>Total Posts: ${member.post_count || 0}</p>
            <p>Messages Sent: ${member.message_count || 0}</p>
        </div>
        ${member.handle_number !== currentUser.handle_number ? `
            <div style="margin-top: 20px;">
                <button class="btn" onclick="startPrivateMessage('${member.handle_number}'); closeProfileModal();">
                    Send Private Message
                </button>
            </div>
        ` : ''}
    `;
    
    modal.style.display = 'flex';
}

function closeProfileModal() {
    document.getElementById('profile-modal').style.display = 'none';
}

// Private messaging
async function loadPrivateMessages() {
    try {
        const data = await apiRequest('/api/private-messages');
        displayPrivateMessages(data.conversations);
        loadPrivateMessageRecipients();
    } catch (error) {
        document.getElementById('pm-list').innerHTML = 
            `<div class="error">Failed to load messages: ${error.message}</div>`;
    }
}

function displayPrivateMessages(conversations) {
    const container = document.getElementById('pm-list');
    
    if (conversations.length === 0) {
        container.innerHTML = '<div class="loading">No private messages yet.</div>';
        return;
    }
    
    container.innerHTML = conversations.map(conv => `
        <div class="pm-item ${conv.unread_count > 0 ? 'unread' : ''}"
             onclick="openPrivateConversation(${conv.id}, '${conv.subject}')">
            <div class="pm-header">
                <div class="pm-participants">${conv.other_participant}</div>
                <div class="pm-timestamp">${new Date(conv.last_message_at).toLocaleDateString()}</div>
            </div>
            <div class="pm-preview">
                <strong>${conv.subject}</strong>
                ${conv.unread_count > 0 ? `<span style="color: #ffaa00;"> (${conv.unread_count} unread)</span>` : ''}
            </div>
        </div>
    `).join('');
}

async function loadPrivateMessageRecipients() {
    try {
        const data = await apiRequest('/api/members');
        const select = document.getElementById('pm-recipient');
        select.innerHTML = '<option value="">Select recipient...</option>' +
            data.members
                .filter(m => m.handle_number !== currentUser.handle_number)
                .map(member => `<option value="${member.handle_number}">${member.handle_number}</option>`)
                .join('');
    } catch (error) {
        console.error('Failed to load recipients:', error);
    }
}

async function openPrivateConversation(conversationId, subject) {
    try {
        const data = await apiRequest(`/api/private-messages/${conversationId}`);
        currentPrivateConversation = { id: conversationId, subject };
        
        document.getElementById('pm-list').classList.add('hidden');
        document.getElementById('new-message-form').classList.add('hidden');
        document.getElementById('pm-conversation').classList.remove('hidden');
        document.getElementById('pm-conversation-title').textContent = subject;
        
        displayPrivateConversation(data.messages);
        
        // Mark as read
        await apiRequest(`/api/private-messages/${conversationId}/read`, { method: 'POST' });
        document.getElementById('pm-badge').classList.add('hidden');
    } catch (error) {
        showNotification(`Failed to load conversation: ${error.message}`, 'error');
    }
}

function displayPrivateConversation(messages) {
    const container = document.getElementById('pm-messages');
    container.innerHTML = messages.map(message => `
        <div class="chat-message">
            <span class="chat-author">${message.sender}:</span>
            ${message.content}
            <span class="chat-time">${new Date(message.created_at).toLocaleString()}</span>
            ${message.sender === currentUser.handle_number ?
                `<button class="chat-delete-btn" onclick="deleteContent('private_message', ${message.id})">×</button>` : ''}
        </div>
    `).join('');
    container.scrollTop = container.scrollHeight;
}

function displayPrivateMessage(message) {
    const container = document.getElementById('pm-messages');
    const messageElement = document.createElement('div');
    messageElement.className = 'chat-message';
    messageElement.innerHTML = `
        <span class="chat-author">${message.sender}:</span>
        ${message.content}
        <span class="chat-time">${new Date(message.created_at).toLocaleString()}</span>
        ${message.sender === currentUser.handle_number ?
            `<button class="chat-delete-btn" onclick="deleteContent('private_message', ${message.id})">×</button>` : ''}
    `;
    container.appendChild(messageElement);
    container.scrollTop = container.scrollHeight;
}

function showNewMessageForm() {
    document.getElementById('pm-list').classList.add('hidden');
    document.getElementById('pm-conversation').classList.add('hidden');
    document.getElementById('new-message-form').classList.remove('hidden');
}

function showMessagesList() {
    document.getElementById('pm-conversation').classList.add('hidden');
    document.getElementById('new-message-form').classList.add('hidden');
    document.getElementById('pm-list').classList.remove('hidden');
    currentPrivateConversation = null;
    loadPrivateMessages();
}

function startPrivateMessage(recipient) {
    showHunterSection('messages');
    showNewMessageForm();
    document.getElementById('pm-recipient').value = recipient;
}

async function handleNewPrivateMessage(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        await apiRequest('/api/private-messages', {
            method: 'POST',
            body: JSON.stringify({
                recipient: formData.get('pm-recipient'),
                subject: formData.get('pm-subject'),
                content: formData.get('pm-content')
            })
        });
        
        showNotification('Private message sent successfully', 'success');
        event.target.reset();
        showMessagesList();
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

async function sendPrivateMessage() {
    const content = document.getElementById('pm-reply').value.trim();
    if (!content || !currentPrivateConversation) return;
    
    try {
        const data = await apiRequest(`/api/private-messages/${currentPrivateConversation.id}/reply`, {
            method: 'POST',
            body: JSON.stringify({ content })
        });
        
        // Mock response for demo
        const mockMessage = {
            id: Date.now(),
            sender: currentUser.handle_number,
            content: content,
            created_at: new Date().toISOString()
        };
        
        displayPrivateMessage(mockMessage);
        document.getElementById('pm-reply').value = '';
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

// Admin functions
async function loadAdminUsers() {
    if (!currentUser.is_admin) {
        showNotification('Access denied', 'error');
        return;
    }
    
    try {
        const data = await apiRequest('/api/admin/users');
        displayAdminUsers(data.users);
    } catch (error) {
        document.getElementById('admin-users-container').innerHTML = `
            <div class="error">Failed to load users: ${error.message}</div>
        `;
    }
}

function displayAdminUsers(users) {
    const container = document.getElementById('admin-users-container');
    container.innerHTML = users.map(user => `
        <div class="user-item">
            <div class="user-info-admin">
                <div>
                    <strong style="color: #ff4444;">${user.handle_number}</strong>
                    ${user.active === 'deleted' ? '<span style="color: #666;"> [DELETED]</span>' : ''}
                    <br>
                    <small style="color: #888;">${user.creed || 'No creed'} | Joined ${new Date(user.created_at).toLocaleDateString()}</small>
                </div>
                <div>
                    <strong>Field Cred:</strong> ${user.field_cred}<br>
                    <small>Threads: ${user.thread_count} | Posts: ${user.post_count}</small>
                </div>
                <div>
                    ${user.email ? `<small style="color: #888;">${user.email}</small>` : ''}
                    ${user.deletion_reason ? `<br><small style="color: #ff4444;">Deleted: ${user.deletion_reason}</small>` : ''}
                </div>
            </div>
            <div class="user-actions">
                ${user.active !== 'deleted' ? `
                    <button class="btn btn-small" onclick="adjustFieldCred(${user.id})">Adjust Cred</button>
                    <button class="btn btn-small" onclick="toggleModerator(${user.id}, ${!user.is_moderator})">${user.is_moderator ? 'Remove Mod' : 'Make Mod'}</button>
                    <button class="btn btn-danger btn-small" onclick="deleteUser(${user.id})">Delete</button>
                ` : ''}
            </div>
        </div>
    `).join('');
}

async function adjustFieldCred(userId) {
    const newCred = prompt('Enter new field cred value:');
    const reason = prompt('Reason for adjustment:');
    
    if (newCred !== null && !isNaN(newCred)) {
        try {
            await apiRequest(`/api/admin/users/${userId}/field-cred`, {
                method: 'PATCH',
                body: JSON.stringify({
                    field_cred: parseInt(newCred),
                    reason: reason || 'Admin adjustment'
                })
            });
            
            showNotification('Field cred updated successfully', 'success');
            loadAdminUsers();
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }
}

async function toggleModerator(userId, makeMod) {
    try {
        await apiRequest(`/api/admin/users/${userId}/moderator`, {
            method: 'PATCH',
            body: JSON.stringify({ is_moderator: makeMod })
        });
        
        showNotification(`User ${makeMod ? 'promoted to' : 'removed from'} moderator`, 'success');
        loadAdminUsers();
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

async function deleteUser(userId) {
    const reason = prompt('Reason for deletion:');
    if (reason && confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        try {
            await apiRequest(`/api/admin/users/${userId}`, {
                method: 'DELETE',
                body: JSON.stringify({ reason })
            });
            
            showNotification('User deleted successfully', 'success');
            loadAdminUsers();
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }
}

function showServerMessageForm() {
    document.getElementById('server-message-form').classList.remove('hidden');
}

function hideServerMessageForm() {
    document.getElementById('server-message-form').classList.add('hidden');
}

async function handleServerMessage(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        await apiRequest('/api/admin/server-message', {
            method: 'POST',
            body: JSON.stringify({
                content: formData.get('server-msg-content'),
                type: formData.get('server-msg-type')
            })
        });
        
        showNotification('Server message sent to all users', 'success');
        showServerMessage(formData.get('server-msg-content'), formData.get('server-msg-type'));
        event.target.reset();
        hideServerMessageForm();
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

async function showPrivateChatsAdmin() {
    try {
        const data = await apiRequest('/api/admin/private-messages');
        displayPrivateChatsAdmin(data.conversations || [
            {
                id: 1,
                participant1: 'witness1',
                participant2: 'hunter001',
                subject: 'Chicago Operations',
                message_count: 5,
                last_message_at: '2024-01-15T18:00:00Z'
            },
            {
                id: 2,
                participant1: 'hunter001',
                participant2: 'tracker007',
                subject: 'Equipment Request',
                message_count: 3,
                last_message_at: '2024-01-14T15:30:00Z'
            }
        ]);
        document.getElementById('private-chats-admin').classList.remove('hidden');
    } catch (error) {
        showNotification(`Failed to load private chats: ${error.message}`, 'error');
    }
}

function displayPrivateChatsAdmin(conversations) {
    const container = document.getElementById('private-chats-list');
    container.innerHTML = conversations.map(conv => `
        <div class="user-item">
            <div class="user-info-admin">
                <div>
                    <strong>${conv.participant1} ↔ ${conv.participant2}</strong><br>
                    <small>Subject: ${conv.subject}</small>
                </div>
                <div>
                    <small>Messages: ${conv.message_count}</small><br>
                    <small>Last: ${new Date(conv.last_message_at).toLocaleDateString()}</small>
                </div>
                <div>
                    <button class="btn btn-small" onclick="viewPrivateChatAdmin(${conv.id})">View Chat</button>
                    <button class="btn btn-danger btn-small" onclick="deletePrivateChatAdmin(${conv.id})">Delete</button>
                </div>
            </div>
        </div>
    `).join('');
}

async function viewPrivateChatAdmin(conversationId) {
    try {
        const data = await apiRequest(`/api/admin/private-messages/${conversationId}`);
        const messages = (data.messages || [
            { created_at: '2024-01-15T17:00:00Z', sender: 'witness1', content: 'Good work on the Chicago report.' },
            { created_at: '2024-01-15T17:30:00Z', sender: 'hunter001', content: 'Thank you. Planning another sweep tomorrow.' }
        ]).map(msg => 
            `[${new Date(msg.created_at).toLocaleString()}] ${msg.sender}: ${msg.content}`
        ).join('\n');
        
        alert(`Private Conversation:\n\n${messages}`);
    } catch (error) {
        showNotification(`Failed to load conversation: ${error.message}`, 'error');
    }
}

async function deletePrivateChatAdmin(conversationId) {
    if (confirm('Delete this entire private conversation?')) {
        try {
            await apiRequest(`/api/admin/private-messages/${conversationId}`, { method: 'DELETE' });
            showNotification('Private conversation deleted', 'success');
            showPrivateChatsAdmin();
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }
}

function exportSystemData() {
    const data = {
        storage: hunterStorage.data,
        chatMessages: chatMessages,
        chatHistory: chatHistory,
        timestamp: new Date().toISOString(),
        user: currentUser.handle_number
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `hunternet-export-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('System data exported', 'success');
}

// Board functions
async function loadBoards() {
    try {
        const data = await apiRequest('/api/boards');
        displayBoards(data.boards);
    } catch (error) {
        document.getElementById('boards-container').innerHTML = `<div class="error">Failed to load boards: ${error.message}</div>`;
    }
}

function displayBoards(boards) {
    const container = document.getElementById('boards-container');
    container.innerHTML = boards.map(board => {
        // Check if user has access to this board
        let hasAccess = true;
        if (board.key === 'admin' && !currentUser.is_admin) {
            hasAccess = false;
        }
        
        const isUserBoard = board.key === 'general' || board.key === currentUser.creed || (board.key === 'admin' && currentUser.is_admin);
        
        return `
            <div class="board-card ${isUserBoard ? 'user-board' : ''}" 
                 onclick="loadThreads('${board.key}', '${board.name}')"
                 style="${!hasAccess ? 'opacity: 0.5; pointer-events: none;' : ''}">
                <div class="board-title">
                    ${board.name}
                    ${board.key === currentUser.creed ? ' <span style="color: #44ff44; font-size: 0.8em;">[YOUR CREED]</span>' : ''}
                    ${currentUser.is_admin && board.key === 'admin' ? ' <span style="color: #ffaa00; font-size: 0.8em;">[ADMIN]</span>' : ''}
                </div>
                <div class="board-description">${board.description}</div>
            </div>
        `;
    }).join('');
}

async function loadThreads(boardKey, boardName) {
    currentBoard = { key: boardKey, name: boardName };
    document.getElementById('board-list-view').classList.add('hidden');
    document.getElementById('thread-list-view').classList.remove('hidden');
    document.getElementById('current-board-name').textContent = boardName;
    document.getElementById('board-title').textContent = boardName;
    document.getElementById('breadcrumb-board').textContent = boardName;
    document.getElementById('breadcrumb-board-2').textContent = boardName;
    
    try {
        const data = await apiRequest(`/api/boards/${boardKey}/threads`);
        displayThreads(data.threads);
    } catch (error) {
        document.getElementById('threads-container').innerHTML = `<div class="error">Failed to load threads: ${error.message}</div>`;
    }
}

function displayThreads(threads) {
    const container = document.getElementById('threads-container');
    container.innerHTML = threads.map(thread => {
        const voteData = hunterStorage.getVote('thread', thread.id) || {
            upvotes: thread.upvotes,
            downvotes: thread.downvotes,
            user_vote: null
        };
        const canDelete = currentUser.is_admin || thread.author === currentUser.handle_number;
        
        return `
            <div class="thread-item ${thread.sticky ? 'sticky' : ''} ${thread.locked ? 'locked' : ''} ${thread.pinned ? 'pinned' : ''}"
                 onclick="loadThread(${thread.id}, '${thread.title}')">
                <div class="thread-title">
                    ${thread.sticky ? '📌 ' : ''}
                    ${thread.locked ? '🔒 ' : ''}
                    ${thread.pinned ? '📍 ' : ''}
                    ${thread.title}
                </div>
                <div class="thread-meta">
                    <span>by ${thread.author}</span>
                    <span>${new Date(thread.created_at).toLocaleDateString()}</span>
                    <span>${thread.post_count} replies</span>
                    ${thread.signal_type ? `<span class="signal-badge">${thread.signal_type}</span>` : ''}
                    ${thread.tags ? `<span>Tags: ${thread.tags}</span>` : ''}
                </div>
                ${createVoteControls('thread', thread.id, voteData)}
                ${canDelete ? `<button class="delete-btn" onclick="event.stopPropagation(); deleteContent('thread', ${thread.id})">×</button>` : ''}
            </div>
        `;
    }).join('');
}

async function loadThread(threadId, threadTitle) {
    currentThread = { id: threadId, title: threadTitle };
    document.getElementById('thread-list-view').classList.add('hidden');
    document.getElementById('thread-view').classList.remove('hidden');
    document.getElementById('current-thread-title').textContent = threadTitle;
    
    try {
        const data = await apiRequest(`/api/threads/${threadId}`);
        displayThread(data.thread, data.posts);
    } catch (error) {
        document.getElementById('thread-content').innerHTML = `<div class="error">Failed to load thread: ${error.message}</div>`;
    }
}

function displayThread(thread, posts) {
    const threadVoteData = hunterStorage.getVote('thread', thread.id) || {
        upvotes: thread.upvotes,
        downvotes: thread.downvotes,
        user_vote: null
    };
    const canDelete = currentUser.is_admin || thread.author === currentUser.handle_number;
    
    const threadContent = document.getElementById('thread-content');
    threadContent.innerHTML = `
        <div class="thread-content">
            <h2>${thread.title}</h2>
            <div class="thread-meta">
                <span>by <span class="post-author" onclick="showMemberProfile('${thread.author}')">${thread.author}</span></span>
                <span>${new Date(thread.created_at).toLocaleDateString()}</span>
                ${thread.signal_type ? `<span class="signal-badge">${thread.signal_type}</span>` : ''}
                ${thread.tags ? `<span>Tags: ${thread.tags}</span>` : ''}
                ${currentUser.is_admin ? `
                    <button class="btn btn-secondary btn-small" onclick="toggleSticky(${thread.id}, ${!thread.sticky})">${thread.sticky ? 'Unstick' : 'Stick'}</button>
                    <button class="btn btn-secondary btn-small" onclick="toggleLocked(${thread.id}, ${!thread.locked})">${thread.locked ? 'Unlock' : 'Lock'}</button>
                    <button class="btn btn-secondary btn-small" onclick="togglePinned(${thread.id}, ${!thread.pinned})">${thread.pinned ? 'Unpin' : 'Pin'}</button>
                ` : ''}
            </div>
            <div class="post-body">${thread.body_md}</div>
            ${thread.image_path ? `<img src="${thread.image_path}" class="image-preview" onclick="openImageModal('${thread.image_path}')">` : ''}
            ${createVoteControls('thread', thread.id, threadVoteData)}
            ${canDelete ? `<button class="delete-btn" onclick="deleteContent('thread', ${thread.id})">×</button>` : ''}
        </div>
    `;
    
    // Show/hide reply form based on thread lock status
    const replyForm = document.getElementById('reply-form');
    if (thread.locked && !currentUser.is_admin) {
        replyForm.style.display = 'none';
    } else {
        replyForm.style.display = 'block';
    }
    
    const postsContainer = document.getElementById('posts-container');
    postsContainer.innerHTML = posts.map(post => {
        const postVoteData = hunterStorage.getVote('post', post.id) || {
            upvotes: post.upvotes,
            downvotes: post.downvotes,
            user_vote: null
        };
        const canDeletePost = currentUser.is_admin || post.author === currentUser.handle_number;
        
        return `
            <div class="post-item">
                <div class="post-header">
                    <span class="post-author" onclick="showMemberProfile('${post.author}')">${post.author}</span>
                    <span class="post-time">${new Date(post.created_at).toLocaleString()}</span>
                </div>
                <div class="post-body">${post.body_md}</div>
                ${post.image_path ? `<img src="${post.image_path}" class="image-preview" onclick="openImageModal('${post.image_path}')">` : ''}
                ${createVoteControls('post', post.id, postVoteData)}
                ${canDeletePost ? `<button class="delete-btn" onclick="deleteContent('post', ${post.id})">×</button>` : ''}
            </div>
        `;
    }).join('');
}

function showBoardList() {
    document.getElementById('thread-list-view').classList.add('hidden');
    document.getElementById('thread-view').classList.add('hidden');
    document.getElementById('new-thread-form').classList.add('hidden');
    document.getElementById('board-list-view').classList.remove('hidden');
    currentBoard = null;
    currentThread = null;
}

function showThreadList() {
    if (!currentBoard) {
        showBoardList();
        return;
    }
    document.getElementById('thread-view').classList.add('hidden');
    document.getElementById('new-thread-form').classList.add('hidden');
    document.getElementById('thread-list-view').classList.remove('hidden');
    currentThread = null;
}

function showNewThreadForm() {
    document.getElementById('thread-list-view').classList.add('hidden');
    document.getElementById('new-thread-form').classList.remove('hidden');
}

// Thread creation and posting
async function handleNewThread(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        showNotification('Creating thread...', 'info');
        let imagePath = null;
        
        const imageFile = document.getElementById('thread-image').files[0];
        if (imageFile) {
            showNotification('Uploading image...', 'info');
            // Mock image upload
            imagePath = '/uploads/mock-image-' + Date.now() + '.jpg';
        }
        
        await apiRequest(`/api/boards/${currentBoard.key}/threads`, {
            method: 'POST',
            body: JSON.stringify({
                title: formData.get('title'),
                body_md: formData.get('body_md'),
                signal: formData.get('signal'),
                tags: formData.get('tags'),
                image_path: imagePath
            })
        });
        
        showNotification('Thread created successfully', 'success');
        event.target.reset();
        document.getElementById('thread-preview').classList.add('hidden');
        showThreadList();
        loadThreads(currentBoard.key, currentBoard.name);
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

async function handleNewPost(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        showNotification('Posting reply...', 'info');
        let imagePath = null;
        
        const imageFile = document.getElementById('post-image').files[0];
        if (imageFile) {
            showNotification('Uploading image...', 'info');
            // Mock image upload
            imagePath = '/uploads/mock-image-' + Date.now() + '.jpg';
        }
        
        await apiRequest(`/api/threads/${currentThread.id}/posts`, {
            method: 'POST',
            body: JSON.stringify({
                body_md: formData.get('body_md'),
                image_path: imagePath
            })
        });
        
        showNotification('Reply posted successfully', 'success');
        event.target.reset();
        document.getElementById('post-preview').classList.add('hidden');
        loadThread(currentThread.id, currentThread.title);
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

// Thread moderation functions
async function toggleSticky(threadId, sticky) {
    try {
        await apiRequest(`/api/threads/${threadId}`, {
            method: 'PATCH',
            body: JSON.stringify({ sticky })
        });
        loadThread(threadId, currentThread.title);
        showNotification(`Thread ${sticky ? 'stickied' : 'unstickied'}`, 'success');
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

async function toggleLocked(threadId, locked) {
    try {
        await apiRequest(`/api/threads/${threadId}`, {
            method: 'PATCH',
            body: JSON.stringify({ locked })
        });
        loadThread(threadId, currentThread.title);
        showNotification(`Thread ${locked ? 'locked' : 'unlocked'}`, 'success');
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

async function togglePinned(threadId, pinned) {
    try {
        await apiRequest(`/api/threads/${threadId}`, {
            method: 'PATCH',
            body: JSON.stringify({ pinned })
        });
        loadThread(threadId, currentThread.title);
        showNotification(`Thread ${pinned ? 'pinned' : 'unpinned'}`, 'success');
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

// Chat functions
async function loadChatRooms() {
    try {
        const data = await apiRequest('/api/chat/rooms');
        displayChatRooms(data.rooms);
    } catch (error) {
        console.error('Failed to load chat rooms:', error);
        showNotification('Failed to load chat rooms', 'error');
    }
}

function displayChatRooms(rooms) {
    const container = document.getElementById('chat-rooms-list');
    container.innerHTML = rooms.map(room => {
        // Check if user has access to this room
        let hasAccess = true;
        if (room.key === 'admin' && !currentUser.is_admin) {
            hasAccess = false;
        }
        if (room.key !== 'global' && room.key !== 'admin' && currentUser.creed !== room.key) {
            // Allow access to affiliation rooms if user belongs to that creed
            // But still show all rooms for now, just highlight user's own
        }
        
        const isUserRoom = room.key === 'global' || room.key === currentUser.creed || (room.key === 'admin' && currentUser.is_admin);
        
        return `
            <div class="chat-room ${room.key === currentChatRoom ? 'active' : ''} ${isUserRoom ? 'user-room' : ''}"
                 onclick="joinChatRoom('${room.key}')" 
                 style="${!hasAccess ? 'opacity: 0.5; pointer-events: none;' : ''}">
                ${room.title}
                ${room.key === currentUser.creed ? '<span style="color: #44ff44;">[YOUR CREED]</span>' : ''}
                ${currentUser.is_admin && room.key === 'admin' ? '<span style="color: #ffaa00;">[ADMIN]</span>' : ''}
            </div>
        `;
    }).join('');
}

function joinChatRoom(roomKey) {
    currentChatRoom = roomKey;
    if (socket && socket.connected) {
        socket.emit('join', roomKey);
    }
    loadChatMessages(roomKey);
    loadChatMembers();
    
    // Update UI
    document.querySelectorAll('.chat-room').forEach(room => room.classList.remove('active'));
    event.target.classList.add('active');
}

async function loadChatMessages(roomKey) {
    try {
        // Load from persistent history
        if (chatHistory[roomKey]) {
            chatMessages[roomKey] = [...chatHistory[roomKey]];
            displayCachedMessages(chatHistory[roomKey]);
            return;
        }
        
        // Fallback to API if no history
        const data = await apiRequest(`/api/chat/rooms/${roomKey}/messages?limit=50`);
        chatMessages[roomKey] = data.messages;
        displayCachedMessages(data.messages);
    } catch (error) {
        console.error('Failed to load chat messages:', error);
        showNotification('Failed to load chat messages', 'error');
    }
}

function displayCachedMessages(messages) {
    const container = document.getElementById('chat-messages');
    container.innerHTML = messages.map(message => {
        const canDelete = currentUser.is_admin || message.author === currentUser.handle_number ||
            (currentUser.is_moderator && isModeratorOfRoom(currentChatRoom));
        const isMention = message.body && message.body.includes(`@${currentUser.handle_number}`);
        
        return `
            <div class="chat-message ${isMention ? 'mention' : ''}">
                <span class="chat-author" onclick="showMemberProfile('${message.author}')">${message.author}:</span>
                ${formatChatMessage(message.body)}
                <span class="chat-time">${new Date(message.created_at).toLocaleTimeString()}</span>
                ${message.image_path ? `<br><img src="${message.image_path}" class="image-preview" onclick="openImageModal('${message.image_path}')">` : ''}
                ${canDelete ? `<button class="chat-delete-btn" onclick="deleteContent('message', ${message.id})">×</button>` : ''}
            </div>
        `;
    }).join('');
    container.scrollTop = container.scrollHeight;
}

function displayChatMessage(message) {
    const container = document.getElementById('chat-messages');
    const canDelete = currentUser.is_admin || message.author === currentUser.handle_number ||
        (currentUser.is_moderator && isModeratorOfRoom(currentChatRoom));
    const isMention = message.body && message.body.includes(`@${currentUser.handle_number}`);
    
    const messageElement = document.createElement('div');
    messageElement.className = `chat-message ${isMention ? 'mention' : ''}`;
    messageElement.innerHTML = `
        <span class="chat-author" onclick="showMemberProfile('${message.author}')">${message.author}:</span>
        ${formatChatMessage(message.body)}
        <span class="chat-time">${new Date(message.created_at).toLocaleTimeString()}</span>
        ${message.image_path ? `<br><img src="${message.image_path}" class="image-preview" onclick="openImageModal('${message.image_path}')">` : ''}
        ${canDelete ? `<button class="chat-delete-btn" onclick="deleteContent('message', ${message.id})">×</button>` : ''}
    `;
    
    container.appendChild(messageElement);
    container.scrollTop = container.scrollHeight;
    
    // Show notification for mentions
    if (isMention) {
        showNotification(`${message.author} mentioned you in chat`, 'info');
    }
}

function formatChatMessage(body) {
    // Convert @mentions to clickable links
    return body.replace(/@(\w+)/g, '<span style="color: #ffaa00; cursor: pointer;" onclick="showMemberProfile(\'$1\')">@$1</span>');
}

function isModeratorOfRoom(roomKey) {
    // This would need to be populated from the room data
    // For now, assume moderators can moderate all rooms
    return currentUser.is_moderator;
}

async function loadChatMembers() {
    try {
        const data = await apiRequest(`/api/chat/rooms/${currentChatRoom}/members`);
        updateOnlineMembers(data.members || [
            { handle_number: 'witness1', is_admin: true, is_moderator: true },
            { handle_number: 'hunter001', is_admin: false, is_moderator: false },
            { handle_number: 'tracker007', is_admin: false, is_moderator: true }
        ]);
    } catch (error) {
        console.error('Failed to load chat members:', error);
    }
}

function updateOnlineMembers(users) {
    onlineMembers = users;
    const chatMembersList = document.getElementById('chat-members-list');
    if (chatMembersList) {
        chatMembersList.innerHTML = users.map(user => `
            <div class="member-item" onclick="showMemberProfile('${user.handle_number}')">
                <div class="online-status online"></div>
                <div class="member-name">
                    ${user.handle_number}
                    ${user.is_admin ? '<span style="color: #ffaa00;">[WITNESS]</span>' : ''}
                    ${user.is_moderator && !user.is_admin ? '<span style="color: #4444ff;">[MOD]</span>' : ''}
                </div>
            </div>
        `).join('');
    }
}

async function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if ((!message && !chatImageData) || !socket || !socket.connected) {
        if (!socket || !socket.connected) {
            showNotification('Chat disconnected. Reconnecting...', 'error');
            initializeSocket();
        } else {
            showNotification('Please enter a message or select an image', 'error');
        }
        return;
    }
    
    try {
        let imagePath = null;
        if (chatImageData) {
            showNotification('Uploading image...', 'info');
            // Mock image upload
            imagePath = '/uploads/chat-image-' + Date.now() + '.jpg';
        }
        
        // Mock sending message and add to history
        const mockMessage = {
            id: Date.now(),
            author: currentUser.handle_number,
            body: message || '(image)',
            created_at: new Date().toISOString(),
            room_key: currentChatRoom,
            image_path: imagePath
        };
        
        // Add to persistent history
        if (!chatHistory[currentChatRoom]) {
            chatHistory[currentChatRoom] = [];
        }
        chatHistory[currentChatRoom].push(mockMessage);
        
        displayChatMessage(mockMessage);
        
        // Add to cache
        if (!chatMessages[currentChatRoom]) {
            chatMessages[currentChatRoom] = [];
        }
        chatMessages[currentChatRoom].push(mockMessage);
        
        input.value = '';
        clearChatImage();
    } catch (error) {
        console.error('Chat send error:', error);
        showNotification('Failed to send message: ' + error.message, 'error');
    }
}

function handleChatKeypress(event) {
    if (event.key === 'Enter') {
        sendChatMessage();
    }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', async () => {
    showNotification('Anonymous Liberty portal online', 'success');
    
    // Close profile modal when clicking outside
    document.getElementById('profile-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('profile-modal')) {
            closeProfileModal();
        }
    });
    
    // Close image modal when clicking outside
    document.getElementById('image-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('image-modal')) {
            closeImageModal();
        }
    });
    
    console.log('Hunter-Net system initialized');
});
</script>
</body>
</html>
